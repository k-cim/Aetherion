// === File: ThemeManager.swift
// Version: 1.4
// Date: 2025-08-30 20:45:00 UTC
// Description: Central theme store: manages selected Theme, background color live/persistent, card gradient.
// Author: K-Cim

import SwiftUI

@MainActor
final class ThemeManager: ObservableObject {
    // Selected base theme
    @Published var theme: Theme

    // Live background color (affects ThemedScreen)
    @Published var backgroundColor: Color

    // Keep defaults for reset
    private let defaultTheme: Theme
    private let defaultBackground: Color

    // Init
    init(default id: ThemeID) {
        // Base theme (correspond Ã  ta struct Theme dans Theme.swift)
        let t = Theme(id: id,
                      background: .black,
                      foreground: .white,
                      secondary: .gray,
                      cardStartOpacity: 0.30,
                      cardEndOpacity: 0.10,
                      cornerRadius: 16.0)
        self.theme = t
        self.defaultTheme = t

        // Background: load persisted or fallback
        let persistedBG = ThemePersistence.shared.loadBackgroundColor(default: .black)
        self.backgroundColor = persistedBG
        self.defaultBackground = .black

        // Load persisted card gradient if any
        let (start, end) = ThemePersistence.shared.loadCardGradient(defaultStart: t.cardStartOpacity,
                                                                   defaultEnd: t.cardEndOpacity)
        self.theme.cardStartOpacity = start
        self.theme.cardEndOpacity   = end
    }

    // MARK: - Background color controls

    func updateBackgroundColor(_ color: Color) {
        // Live update only
        self.backgroundColor = color
    }

    func applyBackgroundColor(_ color: Color) {
        self.backgroundColor = color
        ThemePersistence.shared.saveBackgroundColor(color)
    }

    func resetBackgroundColor() {
        self.backgroundColor = defaultBackground
        ThemePersistence.shared.saveBackgroundColor(defaultBackground)
    }

    // MARK: - Card gradient controls (ThemeConfigView)

    func liveUpdateCardGradient(startOpacity: Double, endOpacity: Double) {
        theme.cardStartOpacity = startOpacity
        theme.cardEndOpacity   = endOpacity
    }

    func applyCardGradient(startOpacity: Double, endOpacity: Double) {
        theme.cardStartOpacity = startOpacity
        theme.cardEndOpacity   = endOpacity
        ThemePersistence.shared.saveCardGradient(start: startOpacity, end: endOpacity)
    }

    func resetCardGradient() {
        theme.cardStartOpacity = defaultTheme.cardStartOpacity
        theme.cardEndOpacity   = defaultTheme.cardEndOpacity
        ThemePersistence.shared.saveCardGradient(start: theme.cardStartOpacity, end: theme.cardEndOpacity)
    }
}
